<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/c9a6334638ac74e5.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-decb145ea5426c4a.js"/><script src="/_next/static/chunks/4bd1b696-f43195ed8c50a5ee.js" async=""></script><script src="/_next/static/chunks/684-f3d53cf6ae46a13b.js" async=""></script><script src="/_next/static/chunks/main-app-b422431e092c98bc.js" async=""></script><script src="/_next/static/chunks/874-3b2e13d78f8618dd.js" async=""></script><script src="/_next/static/chunks/63-28726393f539b62f.js" async=""></script><script src="/_next/static/chunks/app/layout-16f2661fbedcd9f0.js" async=""></script><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2657417531473772" crossorigin="anonymous"></script><script src="/_next/static/chunks/app/posts/%5Bid%5D/page-bb0e289bc5bd1f55.js" async=""></script><meta name="next-size-adjust" content=""/><title>EKS Custom Networking</title><meta name="description" content="Subnet에 Pod가 할당받을 IP가 부족한 문제를 해결하는 방법"/><meta name="keywords" content="infra, aws, eks, custom networking"/><meta property="og:title" content="EKS Custom Networking"/><meta property="og:description" content="Subnet에 Pod가 할당받을 IP가 부족한 문제를 해결하는 방법"/><meta property="og:url" content="https://comstering.github.io/posts/eks-custom-networking"/><meta property="og:image" content="https://comstering.github.io/eks.png"/><meta property="og:type" content="article"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="EKS Custom Networking"/><meta name="twitter:description" content="Subnet에 Pod가 할당받을 IP가 부족한 문제를 해결하는 방법"/><meta name="twitter:image" content="https://comstering.github.io/eks.png"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="1024x1024"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__className_e8ce0c bg-white text-black dark:bg-zinc-900 dark:text-white"><header class="border-b border-gray-200 dark:border-zinc-700"><div class="max-w-6xl mx-auto flex items-center justify-between px-4 py-4"><a class="flex items-center space-x-2" href="/"><img alt="Profile" loading="lazy" width="180" height="60" decoding="async" data-nimg="1" class="rounded-full object-cover" style="color:transparent" src="/blog-logo.png"/></a><div class="flex items-center space-x-4"><button aria-label="Toggle Dark Mode"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg></button><button aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg></button></div></div></header><main class="max-w-6xl mx-auto px-4 py-8"><div class="max-w-4xl mx-auto p-4 sm:p-8"><div class="mb-8"><a class="text-accent hover:underline flex items-center" href="/"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>Back to home</a></div><h1 class="text-4xl font-extrabold text-foreground mb-4 leading-tight">EKS Custom Networking</h1><p class="text-lg text-muted-foreground mb-6">2025-07-08</p><div class="mb-6 flex flex-wrap gap-2"><span class="bg-blue-600/10 text-blue-400 px-2 py-0.5 rounded text-xs font-medium border border-blue-600/20">infra</span></div><article class="prose lg:prose-xl prose-lg dark:prose-invert max-w-none"><div><h2>VPC CNI</h2>
<h3>VPC CNI의 Pod IP 할당</h3>
<p><img src="/images/posts/contents/eks-custom-networking/not-custom-network.png" alt="not-custom-network"></p>
<p>Pod의 IP를 보면 VPC의 Subnet IP를 그대로 할당받는 것을 볼 수 있다. 이건 VPC CNI의 Pod CNI 할당 방식인데 바로 Node의 Secondary ENI를 그대로 Pod에 할당해서 VPC의 IP 대역을 그대로 Pod가 사용한다.</p>
<h3>ENI IP의 장점</h3>
<p>VPC CNI의 이런 ENI IP 할당하는 방식에는 큰 장점이 있다.</p>
<ol>
<li>
<p>Security Group 설정</p>
<p>VPC CNI는 VPC 대역의 IP를 그대로 사용한다. 그래서 EKS의 Pod 외의 RDS, Redis 등 AWS Resource를 VPC에 Provision했을 때 Security group 설정을 VPC 내부 대역으로 그대로 사용할 수 있어서 Pod가 자체 IP를 갖는 것 보다 훨씬 간단한 rule을 지정할 수 있다.</p>
</li>
<li>
<p>IP direct connect</p>
<p>Pod가 VPC의 내부 IP를 그대로 할당받아서 사용하다 보니 Pod간 통신 뿐 아니라 VPC내에 Provisioning 되어 있는 다른 리소스들과도 IP를 통해서 VPC 라우팅 테이블로 바로 direct 통신이 가능하다. 대표적인 예로 AWS Elastic Load Balancer가 Node instance를 거치지 않고 Pod로 바로 direct 통신이 가능해서 Network hop이 줄어드는 효과를 가져올 수도 있다.</p>
</li>
</ol>
<h2>Subnet에 Pod가 할당받을 IP가 부족하다고?</h2>
<p>위의 이런 VPC CNI의 ENI를 활용한 CNI 방법은 많은 장점을 주지만 여러 단점들을 주기도 한다. 이번 포스팅에서는 그 중 Subnet에 할당할 수 있는 IP가 부족해지는 문제와 해결법을 확인해보려고 한다.</p>
<h3>여러 VPC 간의 Networking</h3>
<p>개인 Side Project나 규모가 작은 프로젝트성 네트워크 구성에서는 거의 일어나지 않는 일이다. 실제로 나도 이것 때문에 문제가 될거라고는 생각하지 못했던 내용이기도 하다.</p>
<p>우리는 VPC를 하나만 쓰는게 아니라 여러 팀에서 각자 VPC를 생성해서 서비스를 운영하고 있다. 여기서 여러 팀들이 서로의 서비스와 통신해야되기 때문에 Transit Gateway를 통해서 서로간의 VPC가 통신한다.</p>
<p><img src="/images/posts/contents/eks-custom-networking/tgw-networking.png" alt="tgw-networking"></p>
<h3>VPC CIDR 대역을 자유롭게 설정하지 못하는 제한이 있어요</h3>
<p>TGW는 가운데에서 서로 다른 VPC의 네트워크를 처리해줘야한다. 이때 TGW가 각 VPC에 대해서 라우팅을 진행해줘야되기 때문에 VPC들의 IP 대역은 서로 겹치면 안된다.</p>
<p>그래서 우리도 IP를 VPC에 마음대로 할당할 수 없는 상태였고 관리팀에서 <code>/21</code> netmask의 크기로 VPC CIDR block을 할당해주었다.</p>
<p>/21 netmask가 작아보이진 않지만 우리 입장해서는 해당 VPC 대역에 public subnet, private subnet, db subnet 등 용도와 public, private 영역에 맞춰 구분을 해야되었고 최종적으로 EKS Node 및 Pod, 그리고 MSK, Private ELB 등 Application에 관련된 private 대역은 netmask /24 대역의 subnet 3개를 사용하게 되었다.</p>
<h3>Subnet의 IP 부족</h3>
<p>netmask /24 대역은 할당 가능한 ip가 수학적으로는 256개이고 3개의 subnet이 있으니 대충 760개 정도의 IP를 사용 가능했다. 하지만 VPC CNI의 Pod IP 할당 방식은 이 Subnet의 IP를 빠른 시간에 다 소모시키기 시작했다.</p>
<p>Pod가 사용하는 IP의 개수는 생각보다 더 많았고 Subnet에는 점점 Pod가 할당 받을 IP가 부족해졌다. 거기에 MSK와 같은 Private Network에 Provisioning한 리소스들과 Private ELB의 IP 사용까지 더해져 EKS에서 Pod에 할당할 수 있는 IP가 더이상 없다는 Error Event와 함께 Pod들이 Scheduling 되지 못하는 사태까지 벌어졌다.</p>
<h2>How to Fix?</h2>
<h3>VPC Secondary CIDR</h3>
<p>AWS VPC에는 기존 VPC를 생성할 때 정해놨던 CIDR 대역에 추가로 CIDR 대역을 더 추가할 수 있다.</p>
<ul>
<li><a href="https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/vpc-cidr-blocks.html#add-cidr-block-restrictions" rel="nofollow" target="_blank">VPC IPv4 CIDR Block</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/add-ipv4-cidr.html" rel="nofollow" target="_blank">VPC CIDR Block 추가</a></li>
</ul>
<h4>CGNAT 대역</h4>
<p>AWS VPC에서는 자신이 할당한 10.0.0.0/x와 같은 CIDR block 대역말고 추가적인 대역을 기존 VPC에 Secondary CIDR Block으로 추가할 수 있게 해준다.</p>
<p>바로 <a href="https://www.purevpn.com/kr/blog/what-is-cgnat/" rel="nofollow" target="_blank">CGNAT 대역</a>인 100.64.0.0/10 대역이다. 기존 VPC에 할당할 수 있는 CIDR 대역인 <a href="http://www.faqs.org/rfcs/rfc1918.html" rel="nofollow" target="_blank">RFC 1918</a> 대역말고 추가로 VPC에 할당 할 수 있는 CIDR block 대역이다.</p>
<p>이 대역은 일반적인 사설 IP 대역과는 다른 IP 대역으로 TGW나 VPC Peering을 했을 때 다른 VPC와 대역이 겹치지 않는다. 즉, 내 VPC 내부에서만 사용되는 CIDR 대역인 것이다.</p>
<h3>EKS Custom Networking</h3>
<p>EKS에서는 <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html" rel="nofollow" target="_blank">Custom Networking</a>이라는 기능을 지원한다.</p>
<p>EKS에서 pod는 기본적으로 Node와 동일한 subnet에서 ip를 할당 받는다. 그 이유는 Pod의 CNI를 Node의 Secondary ENI를 통해서 할당하기 때문이다.</p>
<p>Custom Networking은 Node의 Secondary ENI를 Node와 다른 Subnet에 할당하여 Pod의 CNI를 Node와 다른 Subnet으로 할당하는 방법이다.</p>
<p><img src="/images/posts/contents/eks-custom-networking/custom-networking.png" alt="custom-networking"></p>
<p><em>출처: <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html" rel="nofollow" target="_blank">AWS Documentation</a></em></p>
<h3>해결방법</h3>
<p>위에서 말한 CGNAT 대역의 VPC Secondary CIDR과 EKS Custom Networking을 사용하면 IP 부족문제를 해결할 수 있게 된다.</p>
<ol>
<li>Secondary CIDR로 CGNAT 대역에서 큰 netmask로 생성</li>
<li>EKS Custom Networking의 대상 Subnet을 해당 CGNAT 대역의 Subnet으로 설정</li>
</ol>
<h2>Go to Fix!</h2>
<h3>VPC Secondary CIDR &#x26; Subnet</h3>
<p>먼저 VPC Secondary CIDR과 해당 CIDR Block에 Subnet을 추가한다.</p>
<pre><code class="hljs language-hcl">
locals {
  custom_networking = {
    vpc_cidr = "100.64.0.0/17"
    subnet_cidrs = ["100.64.0.0/19", "100.64.32.0/19", "100.64.64.0/19"]
  }
}

resource "aws_vpc_ipv4_cidr_block_association" "pod_custom_networking" {
  vpc_id     = aws_vpc.main.id
  cidr_block = locals.custom_networking.vpc_cidr
}

resource "aws_subnet" "pod_custom_networking" {
  vpc_id = aws_vpc.main.id
  count  = length(locals.custom_networking.subnet_cidrs)

  cidr_block        = locals.custom_networking.subnet_cidrs[count.index]
  availability_zone = local.az[count.index % var.availability_zone_count]

  tags = {
    Name = "${var.name.vpc}-${var.name.pod_custom_networking_subnet}-${format("%02s", count.index)}-${local.az[count.index % var.availability_zone_count]}"
  }

  depends_on = [aws_vpc_ipv4_cidr_block_association.pod_custom_networking]
}
</code></pre>
<h3>EKS VPC CNI Addon Advanced Configuration</h3>
<p>VPC CNI addon에서 EKS Custom Networking을 사용할 수 있도록 config를 추가한다.</p>
<pre><code class="hljs language-hcl">resource "aws_eks_addon" "vpc_cni" {
  cluster_name  = aws_eks_cluster.main.name
  addon_name    = "vpc-cni"
  addon_version = "v1.19.5-eksbuild.3"

  // 아래 config 추가
  configuration_values = jsonencode({
    env = {
      AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG = "true"
      ENI_CONFIG_LABEL_DEF               = "topology.kubernetes.io/zone"
    }
  })
}
</code></pre>
<h3>EKS ENI Config 설정 (using kubernetes provider)</h3>
<p>이제 VPC CNI 설정이 다 마쳐졌으면 새 Pod들이 Node와 같은 subnet이 아닌 새로 추가된 subnet으로 Scheduling될 수 있도록 ENIConfig를 추가해줘야한다.</p>
<p>일반적인 kubectl 명령어로 local에서 바로 적용할 수도 있지만 subnet id나 subnet의 AZ를 사용해야되고 코드로써 해당 적용 내용의 이력을 남기기 위해서 Terraform에서 Kubernetes Provider를 추가했다.</p>
<h4>Kubernetes Provider</h4>
<pre><code class="hljs language-hcl">data "aws_eks_cluster" "main" {
  name = aws_eks_cluster.main.name
}

data "aws_eks_cluster_auth" "main" {
  name = aws_eks_cluster.main.name
}

# If use terraform cloud
# You need eks access entry add terraform cloud role
provider "kubernetes" {
  host                   = data.aws_eks_cluster.main.endpoint
  cluster_ca_certificate = base64decode(data.aws_eks_cluster.main.certificate_authority[0].data)
  token                  = data.aws_eks_cluster_auth.main.token
}
</code></pre>
<h4>ENIConfig</h4>
<pre><code class="hljs language-hcl">data "aws_subnet" "pod_custom_networking" {
  count = length(locals.custom_networking.subnet_cidrs)
  id    = aws_subnet.pod_custom_networking[count.index].id
}

resource "kubernetes_manifest" "eni_config" {
  count = length(locals.custom_networking.subnet_cidrs)
  manifest = {
    apiVersion = "crd.k8s.amazonaws.com/v1alpha1"
    kind       = "ENIConfig"
    metadata = {
      name = "${data.aws_subnet.pod_custom_networking[count.index].availability_zone}"
    }
    spec = {
      securityGroups = [
        aws_eks_cluster.main.vpc_config[0].cluster_security_group_id
      ]
      subnet = "${data.aws_subnet.pod_custom_networking[count.index].id}"
    }
  }
}
</code></pre>
<h2>Result</h2>
<p>node ip는 10.x.x.x 대역인 것에 대비해서 Pod의 IP는 100.64.x.x 대역인 것을 확인할 수 있다.</p>
<p><img src="/images/posts/contents/eks-custom-networking/custom-networking-result.png" alt="custom-networking-result"></p>
<p>나는 대역을 netmask /19 대역으로 3개 설정했다. 대충 24,000개의 IP를 사용할 수 있게 된 것이다. 기존 760개 정도 할당 가능했던 IP개수와 비교하면 약 31배 정도 더 많아진 양이다. 계속 Pod 수가 늘고 서비스가 많아지면 해당 대역의 IP가 부족해질 수도 있겠지만 그러면 다시 또 새로운 CIDR Block을 추가해서 100.64.x.x 대역을 추가하면 된다.</p>
<p>이 방법을 통해서 관리팀에게 추가 IP를 할당해달라고 요청을 하지 않고도 Pod의 IP 부족 문제를 해결하였다.</p>
<h3>Reference</h3>
<ul>
<li><a href="https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/vpc-cidr-blocks.html" rel="nofollow" target="_blank">VPC CIDR Block</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html" rel="nofollow" target="_blank">EKS Custom Networking</a></li>
<li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/best-practices/custom-networking.html" rel="nofollow" target="_blank">EKS Best Practice Custom Networking</a></li>
</ul></div></article><div class="mt-16 pt-8 border-t border-card"><h2 class="text-2xl font-bold text-foreground mb-6">Comments</h2><div class="giscus-container mt-16"></div></div></div></main><script src="/_next/static/chunks/webpack-decb145ea5426c4a.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[7114,[\"874\",\"static/chunks/874-3b2e13d78f8618dd.js\",\"63\",\"static/chunks/63-28726393f539b62f.js\",\"177\",\"static/chunks/app/layout-16f2661fbedcd9f0.js\"],\"Header\"]\n3:I[7555,[],\"\"]\n4:I[1295,[],\"\"]\n6:I[9665,[],\"OutletBoundary\"]\n9:I[9665,[],\"ViewportBoundary\"]\nb:I[9665,[],\"MetadataBoundary\"]\nd:I[6614,[],\"\"]\n:HL[\"/_next/static/media/e4af272ccee01ff0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/c9a6334638ac74e5.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"5znLCeB_MvEXxL_QoKgzs\",\"p\":\"\",\"c\":[\"\",\"posts\",\"eks-custom-networking\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"posts\",{\"children\":[[\"id\",\"eks-custom-networking\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/c9a6334638ac74e5.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"ko\",\"children\":[[\"$\",\"head\",null,{\"children\":[\"$\",\"script\",null,{\"async\":true,\"src\":\"https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2657417531473772\",\"crossOrigin\":\"anonymous\"}]}],[\"$\",\"body\",null,{\"className\":\"__className_e8ce0c bg-white text-black dark:bg-zinc-900 dark:text-white\",\"children\":[[\"$\",\"$L2\",null,{}],[\"$\",\"main\",null,{\"className\":\"max-w-6xl mx-auto px-4 py-8\",\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]]}]]}]]}],{\"children\":[\"posts\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"id\",\"eks-custom-networking\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L5\",\"$undefined\",null,[\"$\",\"$L6\",null,{\"children\":[\"$L7\",\"$L8\",null]}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"mieq_FpmZUqLh6VIzskCi\",{\"children\":[[\"$\",\"$L9\",null,{\"children\":\"$La\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],[\"$\",\"$Lb\",null,{\"children\":\"$Lc\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$d\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"e:I[6874,[\"874\",\"static/chunks/874-3b2e13d78f8618dd.js\",\"880\",\"static/chunks/app/posts/%5Bid%5D/page-bb0e289bc5bd1f55.js\"],\"\"]\n10:I[7161,[\"874\",\"static/chunks/874-3b2e13d78f8618dd.js\",\"880\",\"static/chunks/app/posts/%5Bid%5D/page-bb0e289bc5bd1f55.js\"],\"default\"]\nf:T2b9b,"])</script><script>self.__next_f.push([1,"\u003ch2\u003eVPC CNI\u003c/h2\u003e\n\u003ch3\u003eVPC CNI의 Pod IP 할당\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"/images/posts/contents/eks-custom-networking/not-custom-network.png\" alt=\"not-custom-network\"\u003e\u003c/p\u003e\n\u003cp\u003ePod의 IP를 보면 VPC의 Subnet IP를 그대로 할당받는 것을 볼 수 있다. 이건 VPC CNI의 Pod CNI 할당 방식인데 바로 Node의 Secondary ENI를 그대로 Pod에 할당해서 VPC의 IP 대역을 그대로 Pod가 사용한다.\u003c/p\u003e\n\u003ch3\u003eENI IP의 장점\u003c/h3\u003e\n\u003cp\u003eVPC CNI의 이런 ENI IP 할당하는 방식에는 큰 장점이 있다.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eSecurity Group 설정\u003c/p\u003e\n\u003cp\u003eVPC CNI는 VPC 대역의 IP를 그대로 사용한다. 그래서 EKS의 Pod 외의 RDS, Redis 등 AWS Resource를 VPC에 Provision했을 때 Security group 설정을 VPC 내부 대역으로 그대로 사용할 수 있어서 Pod가 자체 IP를 갖는 것 보다 훨씬 간단한 rule을 지정할 수 있다.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIP direct connect\u003c/p\u003e\n\u003cp\u003ePod가 VPC의 내부 IP를 그대로 할당받아서 사용하다 보니 Pod간 통신 뿐 아니라 VPC내에 Provisioning 되어 있는 다른 리소스들과도 IP를 통해서 VPC 라우팅 테이블로 바로 direct 통신이 가능하다. 대표적인 예로 AWS Elastic Load Balancer가 Node instance를 거치지 않고 Pod로 바로 direct 통신이 가능해서 Network hop이 줄어드는 효과를 가져올 수도 있다.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eSubnet에 Pod가 할당받을 IP가 부족하다고?\u003c/h2\u003e\n\u003cp\u003e위의 이런 VPC CNI의 ENI를 활용한 CNI 방법은 많은 장점을 주지만 여러 단점들을 주기도 한다. 이번 포스팅에서는 그 중 Subnet에 할당할 수 있는 IP가 부족해지는 문제와 해결법을 확인해보려고 한다.\u003c/p\u003e\n\u003ch3\u003e여러 VPC 간의 Networking\u003c/h3\u003e\n\u003cp\u003e개인 Side Project나 규모가 작은 프로젝트성 네트워크 구성에서는 거의 일어나지 않는 일이다. 실제로 나도 이것 때문에 문제가 될거라고는 생각하지 못했던 내용이기도 하다.\u003c/p\u003e\n\u003cp\u003e우리는 VPC를 하나만 쓰는게 아니라 여러 팀에서 각자 VPC를 생성해서 서비스를 운영하고 있다. 여기서 여러 팀들이 서로의 서비스와 통신해야되기 때문에 Transit Gateway를 통해서 서로간의 VPC가 통신한다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/posts/contents/eks-custom-networking/tgw-networking.png\" alt=\"tgw-networking\"\u003e\u003c/p\u003e\n\u003ch3\u003eVPC CIDR 대역을 자유롭게 설정하지 못하는 제한이 있어요\u003c/h3\u003e\n\u003cp\u003eTGW는 가운데에서 서로 다른 VPC의 네트워크를 처리해줘야한다. 이때 TGW가 각 VPC에 대해서 라우팅을 진행해줘야되기 때문에 VPC들의 IP 대역은 서로 겹치면 안된다.\u003c/p\u003e\n\u003cp\u003e그래서 우리도 IP를 VPC에 마음대로 할당할 수 없는 상태였고 관리팀에서 \u003ccode\u003e/21\u003c/code\u003e netmask의 크기로 VPC CIDR block을 할당해주었다.\u003c/p\u003e\n\u003cp\u003e/21 netmask가 작아보이진 않지만 우리 입장해서는 해당 VPC 대역에 public subnet, private subnet, db subnet 등 용도와 public, private 영역에 맞춰 구분을 해야되었고 최종적으로 EKS Node 및 Pod, 그리고 MSK, Private ELB 등 Application에 관련된 private 대역은 netmask /24 대역의 subnet 3개를 사용하게 되었다.\u003c/p\u003e\n\u003ch3\u003eSubnet의 IP 부족\u003c/h3\u003e\n\u003cp\u003enetmask /24 대역은 할당 가능한 ip가 수학적으로는 256개이고 3개의 subnet이 있으니 대충 760개 정도의 IP를 사용 가능했다. 하지만 VPC CNI의 Pod IP 할당 방식은 이 Subnet의 IP를 빠른 시간에 다 소모시키기 시작했다.\u003c/p\u003e\n\u003cp\u003ePod가 사용하는 IP의 개수는 생각보다 더 많았고 Subnet에는 점점 Pod가 할당 받을 IP가 부족해졌다. 거기에 MSK와 같은 Private Network에 Provisioning한 리소스들과 Private ELB의 IP 사용까지 더해져 EKS에서 Pod에 할당할 수 있는 IP가 더이상 없다는 Error Event와 함께 Pod들이 Scheduling 되지 못하는 사태까지 벌어졌다.\u003c/p\u003e\n\u003ch2\u003eHow to Fix?\u003c/h2\u003e\n\u003ch3\u003eVPC Secondary CIDR\u003c/h3\u003e\n\u003cp\u003eAWS VPC에는 기존 VPC를 생성할 때 정해놨던 CIDR 대역에 추가로 CIDR 대역을 더 추가할 수 있다.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/vpc-cidr-blocks.html#add-cidr-block-restrictions\" rel=\"nofollow\" target=\"_blank\"\u003eVPC IPv4 CIDR Block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/add-ipv4-cidr.html\" rel=\"nofollow\" target=\"_blank\"\u003eVPC CIDR Block 추가\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4\u003eCGNAT 대역\u003c/h4\u003e\n\u003cp\u003eAWS VPC에서는 자신이 할당한 10.0.0.0/x와 같은 CIDR block 대역말고 추가적인 대역을 기존 VPC에 Secondary CIDR Block으로 추가할 수 있게 해준다.\u003c/p\u003e\n\u003cp\u003e바로 \u003ca href=\"https://www.purevpn.com/kr/blog/what-is-cgnat/\" rel=\"nofollow\" target=\"_blank\"\u003eCGNAT 대역\u003c/a\u003e인 100.64.0.0/10 대역이다. 기존 VPC에 할당할 수 있는 CIDR 대역인 \u003ca href=\"http://www.faqs.org/rfcs/rfc1918.html\" rel=\"nofollow\" target=\"_blank\"\u003eRFC 1918\u003c/a\u003e 대역말고 추가로 VPC에 할당 할 수 있는 CIDR block 대역이다.\u003c/p\u003e\n\u003cp\u003e이 대역은 일반적인 사설 IP 대역과는 다른 IP 대역으로 TGW나 VPC Peering을 했을 때 다른 VPC와 대역이 겹치지 않는다. 즉, 내 VPC 내부에서만 사용되는 CIDR 대역인 것이다.\u003c/p\u003e\n\u003ch3\u003eEKS Custom Networking\u003c/h3\u003e\n\u003cp\u003eEKS에서는 \u003ca href=\"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html\" rel=\"nofollow\" target=\"_blank\"\u003eCustom Networking\u003c/a\u003e이라는 기능을 지원한다.\u003c/p\u003e\n\u003cp\u003eEKS에서 pod는 기본적으로 Node와 동일한 subnet에서 ip를 할당 받는다. 그 이유는 Pod의 CNI를 Node의 Secondary ENI를 통해서 할당하기 때문이다.\u003c/p\u003e\n\u003cp\u003eCustom Networking은 Node의 Secondary ENI를 Node와 다른 Subnet에 할당하여 Pod의 CNI를 Node와 다른 Subnet으로 할당하는 방법이다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/posts/contents/eks-custom-networking/custom-networking.png\" alt=\"custom-networking\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e출처: \u003ca href=\"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html\" rel=\"nofollow\" target=\"_blank\"\u003eAWS Documentation\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003ch3\u003e해결방법\u003c/h3\u003e\n\u003cp\u003e위에서 말한 CGNAT 대역의 VPC Secondary CIDR과 EKS Custom Networking을 사용하면 IP 부족문제를 해결할 수 있게 된다.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eSecondary CIDR로 CGNAT 대역에서 큰 netmask로 생성\u003c/li\u003e\n\u003cli\u003eEKS Custom Networking의 대상 Subnet을 해당 CGNAT 대역의 Subnet으로 설정\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eGo to Fix!\u003c/h2\u003e\n\u003ch3\u003eVPC Secondary CIDR \u0026#x26; Subnet\u003c/h3\u003e\n\u003cp\u003e먼저 VPC Secondary CIDR과 해당 CIDR Block에 Subnet을 추가한다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003e\nlocals {\n  custom_networking = {\n    vpc_cidr = \"100.64.0.0/17\"\n    subnet_cidrs = [\"100.64.0.0/19\", \"100.64.32.0/19\", \"100.64.64.0/19\"]\n  }\n}\n\nresource \"aws_vpc_ipv4_cidr_block_association\" \"pod_custom_networking\" {\n  vpc_id     = aws_vpc.main.id\n  cidr_block = locals.custom_networking.vpc_cidr\n}\n\nresource \"aws_subnet\" \"pod_custom_networking\" {\n  vpc_id = aws_vpc.main.id\n  count  = length(locals.custom_networking.subnet_cidrs)\n\n  cidr_block        = locals.custom_networking.subnet_cidrs[count.index]\n  availability_zone = local.az[count.index % var.availability_zone_count]\n\n  tags = {\n    Name = \"${var.name.vpc}-${var.name.pod_custom_networking_subnet}-${format(\"%02s\", count.index)}-${local.az[count.index % var.availability_zone_count]}\"\n  }\n\n  depends_on = [aws_vpc_ipv4_cidr_block_association.pod_custom_networking]\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eEKS VPC CNI Addon Advanced Configuration\u003c/h3\u003e\n\u003cp\u003eVPC CNI addon에서 EKS Custom Networking을 사용할 수 있도록 config를 추가한다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003eresource \"aws_eks_addon\" \"vpc_cni\" {\n  cluster_name  = aws_eks_cluster.main.name\n  addon_name    = \"vpc-cni\"\n  addon_version = \"v1.19.5-eksbuild.3\"\n\n  // 아래 config 추가\n  configuration_values = jsonencode({\n    env = {\n      AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG = \"true\"\n      ENI_CONFIG_LABEL_DEF               = \"topology.kubernetes.io/zone\"\n    }\n  })\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eEKS ENI Config 설정 (using kubernetes provider)\u003c/h3\u003e\n\u003cp\u003e이제 VPC CNI 설정이 다 마쳐졌으면 새 Pod들이 Node와 같은 subnet이 아닌 새로 추가된 subnet으로 Scheduling될 수 있도록 ENIConfig를 추가해줘야한다.\u003c/p\u003e\n\u003cp\u003e일반적인 kubectl 명령어로 local에서 바로 적용할 수도 있지만 subnet id나 subnet의 AZ를 사용해야되고 코드로써 해당 적용 내용의 이력을 남기기 위해서 Terraform에서 Kubernetes Provider를 추가했다.\u003c/p\u003e\n\u003ch4\u003eKubernetes Provider\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003edata \"aws_eks_cluster\" \"main\" {\n  name = aws_eks_cluster.main.name\n}\n\ndata \"aws_eks_cluster_auth\" \"main\" {\n  name = aws_eks_cluster.main.name\n}\n\n# If use terraform cloud\n# You need eks access entry add terraform cloud role\nprovider \"kubernetes\" {\n  host                   = data.aws_eks_cluster.main.endpoint\n  cluster_ca_certificate = base64decode(data.aws_eks_cluster.main.certificate_authority[0].data)\n  token                  = data.aws_eks_cluster_auth.main.token\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003eENIConfig\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-hcl\"\u003edata \"aws_subnet\" \"pod_custom_networking\" {\n  count = length(locals.custom_networking.subnet_cidrs)\n  id    = aws_subnet.pod_custom_networking[count.index].id\n}\n\nresource \"kubernetes_manifest\" \"eni_config\" {\n  count = length(locals.custom_networking.subnet_cidrs)\n  manifest = {\n    apiVersion = \"crd.k8s.amazonaws.com/v1alpha1\"\n    kind       = \"ENIConfig\"\n    metadata = {\n      name = \"${data.aws_subnet.pod_custom_networking[count.index].availability_zone}\"\n    }\n    spec = {\n      securityGroups = [\n        aws_eks_cluster.main.vpc_config[0].cluster_security_group_id\n      ]\n      subnet = \"${data.aws_subnet.pod_custom_networking[count.index].id}\"\n    }\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eResult\u003c/h2\u003e\n\u003cp\u003enode ip는 10.x.x.x 대역인 것에 대비해서 Pod의 IP는 100.64.x.x 대역인 것을 확인할 수 있다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/posts/contents/eks-custom-networking/custom-networking-result.png\" alt=\"custom-networking-result\"\u003e\u003c/p\u003e\n\u003cp\u003e나는 대역을 netmask /19 대역으로 3개 설정했다. 대충 24,000개의 IP를 사용할 수 있게 된 것이다. 기존 760개 정도 할당 가능했던 IP개수와 비교하면 약 31배 정도 더 많아진 양이다. 계속 Pod 수가 늘고 서비스가 많아지면 해당 대역의 IP가 부족해질 수도 있겠지만 그러면 다시 또 새로운 CIDR Block을 추가해서 100.64.x.x 대역을 추가하면 된다.\u003c/p\u003e\n\u003cp\u003e이 방법을 통해서 관리팀에게 추가 IP를 할당해달라고 요청을 하지 않고도 Pod의 IP 부족 문제를 해결하였다.\u003c/p\u003e\n\u003ch3\u003eReference\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/vpc-cidr-blocks.html\" rel=\"nofollow\" target=\"_blank\"\u003eVPC CIDR Block\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html\" rel=\"nofollow\" target=\"_blank\"\u003eEKS Custom Networking\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.aws.amazon.com/ko_kr/eks/latest/best-practices/custom-networking.html\" rel=\"nofollow\" target=\"_blank\"\u003eEKS Best Practice Custom Networking\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"])</script><script>self.__next_f.push([1,"5:[\"$\",\"div\",null,{\"className\":\"max-w-4xl mx-auto p-4 sm:p-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"mb-8\",\"children\":[\"$\",\"$Le\",null,{\"href\":\"/\",\"className\":\"text-accent hover:underline flex items-center\",\"children\":[[\"$\",\"svg\",null,{\"className\":\"w-4 h-4 mr-1\",\"fill\":\"none\",\"stroke\":\"currentColor\",\"viewBox\":\"0 0 24 24\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[\"$\",\"path\",null,{\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"strokeWidth\":\"2\",\"d\":\"M10 19l-7-7m0 0l7-7m-7 7h18\"}]}],\"Back to home\"]}]}],[\"$\",\"h1\",null,{\"className\":\"text-4xl font-extrabold text-foreground mb-4 leading-tight\",\"children\":\"EKS Custom Networking\"}],[\"$\",\"p\",null,{\"className\":\"text-lg text-muted-foreground mb-6\",\"children\":\"2025-07-08\"}],[\"$\",\"div\",null,{\"className\":\"mb-6 flex flex-wrap gap-2\",\"children\":[[\"$\",\"span\",\"infra\",{\"className\":\"bg-blue-600/10 text-blue-400 px-2 py-0.5 rounded text-xs font-medium border border-blue-600/20\",\"children\":\"infra\"}]]}],[\"$\",\"article\",null,{\"className\":\"prose lg:prose-xl prose-lg dark:prose-invert max-w-none\",\"children\":[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$f\"}}]}],[\"$\",\"div\",null,{\"className\":\"mt-16 pt-8 border-t border-card\",\"children\":[[\"$\",\"h2\",null,{\"className\":\"text-2xl font-bold text-foreground mb-6\",\"children\":\"Comments\"}],[\"$\",\"$L10\",null,{\"repo\":\"comstering/comstering.github.io\",\"repoId\":\"MDEwOlJlcG9zaXRvcnkzNjI0MjQ3NDk=\",\"category\":\"Announcements\",\"categoryId\":\"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyOTQ4OTYw\",\"mapping\":\"pathname\",\"strict\":\"0\",\"reactionsEnabled\":\"1\",\"emitMetadata\":\"0\",\"inputPosition\":\"top\",\"theme\":\"dark_high_contrast\",\"lang\":\"ko\",\"loading\":\"lazy\"}]]}]]}]\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n7:null\n"])</script><script>self.__next_f.push([1,"8:null\nc:[[\"$\",\"title\",\"0\",{\"children\":\"EKS Custom Networking\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"Subnet에 Pod가 할당받을 IP가 부족한 문제를 해결하는 방법\"}],[\"$\",\"meta\",\"2\",{\"name\":\"keywords\",\"content\":\"infra, aws, eks, custom networking\"}],[\"$\",\"meta\",\"3\",{\"property\":\"og:title\",\"content\":\"EKS Custom Networking\"}],[\"$\",\"meta\",\"4\",{\"property\":\"og:description\",\"content\":\"Subnet에 Pod가 할당받을 IP가 부족한 문제를 해결하는 방법\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:url\",\"content\":\"https://comstering.github.io/posts/eks-custom-networking\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:image\",\"content\":\"https://comstering.github.io/eks.png\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:type\",\"content\":\"article\"}],[\"$\",\"meta\",\"8\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"9\",{\"name\":\"twitter:title\",\"content\":\"EKS Custom Networking\"}],[\"$\",\"meta\",\"10\",{\"name\":\"twitter:description\",\"content\":\"Subnet에 Pod가 할당받을 IP가 부족한 문제를 해결하는 방법\"}],[\"$\",\"meta\",\"11\",{\"name\":\"twitter:image\",\"content\":\"https://comstering.github.io/eks.png\"}],[\"$\",\"link\",\"12\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"1024x1024\"}]]\n"])</script></body></html>