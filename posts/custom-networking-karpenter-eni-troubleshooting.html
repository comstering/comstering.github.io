<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/e4af272ccee01ff0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/5542cab367cb990f.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-decb145ea5426c4a.js"/><script src="/_next/static/chunks/4bd1b696-f43195ed8c50a5ee.js" async=""></script><script src="/_next/static/chunks/684-f3d53cf6ae46a13b.js" async=""></script><script src="/_next/static/chunks/main-app-b422431e092c98bc.js" async=""></script><script src="/_next/static/chunks/874-3b2e13d78f8618dd.js" async=""></script><script src="/_next/static/chunks/63-28726393f539b62f.js" async=""></script><script src="/_next/static/chunks/app/layout-16f2661fbedcd9f0.js" async=""></script><script src="/_next/static/chunks/app/posts/%5Bid%5D/page-bb0e289bc5bd1f55.js" async=""></script><meta name="next-size-adjust" content=""/><title>Custom network Kapenter ENI troubleshooting</title><meta name="description" content="Karpenter Node가 할당 가능한 IP 개수보다 더 많은 Pod를 Scheduling 하는 문제 해결"/><meta name="keywords" content="infra, aws, eks, custom networking, karpenter, troubleshooting"/><meta property="og:title" content="Custom network Kapenter ENI troubleshooting"/><meta property="og:description" content="Karpenter Node가 할당 가능한 IP 개수보다 더 많은 Pod를 Scheduling 하는 문제 해결"/><meta property="og:url" content="https://comstering.github.io/posts/custom-networking-karpenter-eni-troubleshooting"/><meta property="og:image" content="https://comstering.github.io/eks.png"/><meta property="og:type" content="article"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Custom network Kapenter ENI troubleshooting"/><meta name="twitter:description" content="Karpenter Node가 할당 가능한 IP 개수보다 더 많은 Pod를 Scheduling 하는 문제 해결"/><meta name="twitter:image" content="https://comstering.github.io/eks.png"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="1024x1024"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__className_e8ce0c bg-white text-black dark:bg-zinc-900 dark:text-white"><header class="border-b border-gray-200 dark:border-zinc-700"><div class="max-w-6xl mx-auto flex items-center justify-between px-4 py-4"><a class="flex items-center space-x-2" href="/"><img alt="Profile" loading="lazy" width="180" height="60" decoding="async" data-nimg="1" class="rounded-full object-cover" style="color:transparent" src="/blog-logo.png"/></a><div class="flex items-center space-x-4"><button aria-label="Toggle Dark Mode"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg></button><button aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg></button></div></div></header><main class="max-w-6xl mx-auto px-4 py-8"><div class="max-w-4xl mx-auto p-4 sm:p-8"><div class="mb-8"><a class="text-accent hover:underline flex items-center" href="/"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>Back to home</a></div><h1 class="text-4xl font-extrabold text-foreground mb-4 leading-tight">Custom network Kapenter ENI troubleshooting</h1><p class="text-lg text-muted-foreground mb-6">2025-07-10</p><div class="mb-6 flex flex-wrap gap-2"><span class="bg-blue-600/10 text-blue-400 px-2 py-0.5 rounded text-xs font-medium border border-blue-600/20">infra</span></div><article class="prose lg:prose-xl prose-lg dark:prose-invert max-w-none"><div><h2>Karpenter Node에 할당가능한 Pod보다 더 많은 Node가 Scheduling 되고 있어요</h2>
<p>열심히 Custom Networking을 설정하고 Pod를 모니터링하고 있었는데 이상한 현상이 발생했다.</p>
<p><img src="/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/pod-not-scheduled.png" alt="pod-not-scheduled"></p>
<p>Pod가 ContainerCreating 상태에서 더이상 다음 단계로 진행이 되지 않고 멈춰서 실행이 안되고 있던 것이다.</p>
<p>그래서 Pod가 왜 실행이 안되고 있는지 Pod Event를 확인해봤다.</p>
<h3>Failed to assign an IP address to container</h3>
<p><img src="/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/pod-schedule-failed-event.png" alt="pod-schedule-failed-event"></p>
<p>Event를 보면 Pod에 aws-cni에서 IP를 더이상 할당할 수 없다는 오류가 나오고 있었다.</p>
<p>이미 Custom Networking으로 Pod의 IP 여유공간을 충분하다 못해 넘치게 설정한 내 입장에서는 도저히 이해할 수 없는 상황이었다.</p>
<p>그래서 문제를 찾던 도중 이런 상황이 eks node-group의 Node에서는 발생하지 않고 Karpenter에서 만든 Node에서만 발생한다는 사실을 알았다.</p>
<h2>Node가 할당 가능한 IP 개수</h2>
<p>Karpenter로 뜬 Node 하나의 스펙을 확인해봤다.</p>
<p><img src="/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/node-spec.png" alt="node-spec"></p>
<p>현재 Node는 t4g.medium type의 instance가 띄워진 상태였고 EC2 스펙에서 EC2의 할당 가능한 ENI개수를 확인해봤다.</p>
<h3>EC2 Network Spec</h3>
<p><img src="/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/ec2-network-spec.png" alt="ec2-network-spec"></p>
<p>t4g.large와 t4g.medium의 network interface를 확인해본 결과 각각 3개의 network interface가 존재하지만 network interface당 할당 가능한 IP가 12개, 6개로 되어 있었다.</p>
<p>계산상으로만 하면 t4g.large는 36개의 IP를, t4g.medium은 18개의 ip를 할당할 수 있다.</p>
<p>여기서 Node가 자체 IP를 가져야하기 때문에 Node IP 1개를 제외하면 각각 t4g.large는 35개, t4g.medium은 17개의 IP를 Pod에 할당할 수 있다.</p>
<h3>Custom Networking으로 Pod에 할당 가능한 IP 개수가 줄어들었다.</h3>
<p>그런데 EKS console 상에서 custom networking이 설정된 default node group의 EC2인 t4g.large에 35개의 Pod 할당이 아닌 24개의 Pod가 할당가능하다고 표시되어 있었다.</p>
<p><img src="/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/t4g.large-pod-cound.png" alt="t4g.large-pod-cound"></p>
<h4>Custom Networking의 할당 가능한 Pod 개수</h4>
<p>Custom Netoworking이 적용되지 않은 기존 EC2 Node의 Pod에 할당 가능한 IP 개수 계산은 아래와 같다.</p>
<pre><code class="hljs language-scss">(ENI count) * (IP addr per interface) - <span class="hljs-number">1</span>
</code></pre>
<p>ENI개수에서 할당 가능한 IP 개수를 곱하고 Node가 가져가야할 IP 한개를 제외한 나머지 IP들을 모두 사용할 수 있다.</p>
<p>하지만 Custom Networking을 사용하는 순간 사용가능한 IP 개수가 완전히 바뀌게 된다.</p>
<p>ENI 1개를 제외하고 나머지 ENI의 IP 할당 개수 만큼 사용할 수 있다.</p>
<pre><code class="hljs language-ini">(ENI count - 1) * (IP addr per interface)

tg4.medium의 경우
기존: 3 * 6 - 1(Node 자체 IP) = 17
custom network: (3-1) * <span class="hljs-attr">6</span> = <span class="hljs-number">12</span>
</code></pre>
<p>이렇게 사용가능한 IP가 줄어드는 이유는 EC2 Node의 IP와 Pod의 IP가 완전히 서로 다른 대역을 사용하기 때문이다.</p>
<p><img src="/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/custom-networking.png" alt="custom-networking"></p>
<p><em>출처: <a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html">AWS Documentation</a></em></p>
<p>그림에서 보이듯이 Node는 10.0.0.0/24 대역을 사용하는 반면, Pod는 100.64.0.0/16 대역을 사용한다.</p>
<p>ENI에서 할당하는 IP는 ENI가 속한 Subnet IP 대역의 IP로만 할당이 가능하다. 이 부분에서 Pod에 할당 가능한 IP 개수가 줄어들게 되는 것이다.</p>
<p>Node는 10.0.0.0/24 대역의 IP를 사용해야하기 때문에 ENI 하나를 사용해서 10.0.0.0/24 대역에 IP를 할당 받는다. 그리고 남은 ENI를 사용해서 Custom Networking을 사용할 IP 대역으로 ENI에 IP를 할당한다. 그래서 ENI 1개를 빼고 나머지 ENI에 대해서 곱한 개수만이 Pod의 IP로 할당 가능하다.</p>
<h2>Karpenter는 이 사실을 모른다!</h2>
<p>eks의 node group는 vpc-cni addon과 eks 자체 managed를 통해서 자동적으로 Node에 할당 가능한 IP를 알고 그 이상으로 Pod를 Scheduling하지 않는다.</p>
<p>하지만 Karpenter의 Node는 EKS에서 Managed되고 있는 Node가 아니라 Karpenter가 직접 Managed하고 있는 Node이다. 그래서 현재 EC2의 ENI 개수가 몇개인지, 할당 가능한 IP 개수가 변경되었는지도 모르고 기존의 IP할당 가능한 개수만큼의 Pod를 Node에 할당할 수 있다고 판단한다.</p>
<p>그래서 Node에서는 할당할 수 있는 IP가 없는데 Pod는 계속 Scheduling되려고 하는데 Karpenter는 아직 Node에 Pod가 할당할 수 있다고 판단하여 추가 Node를 생성하지 않는 것이다.</p>
<h3>How to Fix?</h3>
<p>그래서 Custom Networking을 적용했을 때는 EC2의 ENI 1개를 사용할 수 없다는 걸 Karpenter에게 알려줘서 Node에 Scheduling될 수 있는 Pod의 개수를 조정해주어야한다.</p>
<h3>Karpenter 추가 설정</h3>
<h4>ReservedENIs</h4>
<p>Karpenter 공식문서에서 이미 이 내용에 대해서 명시해주고 있다.</p>
<p><img src="/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/karpenter-docs-note.png" alt="karpenter-docs-note"></p>
<p>내용은 간단하다. Karpenter Node에 ENI 1개를 예약된 ENI로 등록하여 사용하지 않게 설정하면 된다. 기존 Karpenter values에서 아래의 값만 추가하면 된다.</p>
<pre><code class="hljs language-yaml"><span class="hljs-comment"># Karpenter values.yaml</span>
<span class="hljs-comment">## 중략...</span>
<span class="hljs-attr">settings:</span>
  <span class="hljs-attr">clusterName:</span> <span class="hljs-string">${EKS_CLUSTER_NAME}</span>
  <span class="hljs-attr">interruptionQueue:</span> <span class="hljs-string">Karpenter-${EKS_CLUSTER_NAME}-SpotInterruptionQueue</span>
  <span class="hljs-attr">reservedENIs:</span> <span class="hljs-string">"1"</span> <span class="hljs-comment"># 여기 추가</span>
  <span class="hljs-comment"># 설정하지 않으면 default가 0, custom networking으로 1개의 eni를 사용할 수 없으므로 1을 입력하여 ENI 1개가 예약된 상태여서 사용할 수 없다고 명시</span>
</code></pre>
<h2>Fixed</h2>
<p>기존에 이미 생성된 Node들은 변경된 설정을 인식하지 못해서 이전 설정 그대로 남아있다. 그래서 반드시 Node의 Drain, Delete를 통해서 새 Node를 생성하고 기존 Karpenter Node를 제거하여 ReservedENIs를 인식한 새 Node가 Pod를 실행하도록 해야한다.</p>
<h3>Reference</h3>
<ul>
<li><a href="https://karpenter.sh/docs/reference/settings/">Karpenter Settings</a></li>
</ul></div></article><div class="mt-16 pt-8 border-t border-card"><h2 class="text-2xl font-bold text-foreground mb-6">Comments</h2><div class="giscus-container mt-16"></div></div></div></main><script src="/_next/static/chunks/webpack-decb145ea5426c4a.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[7114,[\"874\",\"static/chunks/874-3b2e13d78f8618dd.js\",\"63\",\"static/chunks/63-28726393f539b62f.js\",\"177\",\"static/chunks/app/layout-16f2661fbedcd9f0.js\"],\"Header\"]\n3:I[7555,[],\"\"]\n4:I[1295,[],\"\"]\n6:I[9665,[],\"OutletBoundary\"]\n9:I[9665,[],\"ViewportBoundary\"]\nb:I[9665,[],\"MetadataBoundary\"]\nd:I[6614,[],\"\"]\n:HL[\"/_next/static/media/e4af272ccee01ff0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n:HL[\"/_next/static/css/5542cab367cb990f.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"i950vw5PfjSrQNkggriZi\",\"p\":\"\",\"c\":[\"\",\"posts\",\"custom-networking-karpenter-eni-troubleshooting\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"posts\",{\"children\":[[\"id\",\"custom-networking-karpenter-eni-troubleshooting\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/5542cab367cb990f.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"ko\",\"children\":[\"$\",\"body\",null,{\"className\":\"__className_e8ce0c bg-white text-black dark:bg-zinc-900 dark:text-white\",\"children\":[[\"$\",\"$L2\",null,{}],[\"$\",\"main\",null,{\"className\":\"max-w-6xl mx-auto px-4 py-8\",\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}]]}]}]]}],{\"children\":[\"posts\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"id\",\"custom-networking-karpenter-eni-troubleshooting\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L5\",\"$undefined\",null,[\"$\",\"$L6\",null,{\"children\":[\"$L7\",\"$L8\",null]}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"VKMCwhoEhzvBW0tJ7YvbU\",{\"children\":[[\"$\",\"$L9\",null,{\"children\":\"$La\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}],[\"$\",\"$Lb\",null,{\"children\":\"$Lc\"}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$d\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"e:I[6874,[\"874\",\"static/chunks/874-3b2e13d78f8618dd.js\",\"880\",\"static/chunks/app/posts/%5Bid%5D/page-bb0e289bc5bd1f55.js\"],\"\"]\n10:I[7161,[\"874\",\"static/chunks/874-3b2e13d78f8618dd.js\",\"880\",\"static/chunks/app/posts/%5Bid%5D/page-bb0e289bc5bd1f55.js\"],\"default\"]\nf:T1d78,"])</script><script>self.__next_f.push([1,"\u003ch2\u003eKarpenter Node에 할당가능한 Pod보다 더 많은 Node가 Scheduling 되고 있어요\u003c/h2\u003e\n\u003cp\u003e열심히 Custom Networking을 설정하고 Pod를 모니터링하고 있었는데 이상한 현상이 발생했다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/pod-not-scheduled.png\" alt=\"pod-not-scheduled\"\u003e\u003c/p\u003e\n\u003cp\u003ePod가 ContainerCreating 상태에서 더이상 다음 단계로 진행이 되지 않고 멈춰서 실행이 안되고 있던 것이다.\u003c/p\u003e\n\u003cp\u003e그래서 Pod가 왜 실행이 안되고 있는지 Pod Event를 확인해봤다.\u003c/p\u003e\n\u003ch3\u003eFailed to assign an IP address to container\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/pod-schedule-failed-event.png\" alt=\"pod-schedule-failed-event\"\u003e\u003c/p\u003e\n\u003cp\u003eEvent를 보면 Pod에 aws-cni에서 IP를 더이상 할당할 수 없다는 오류가 나오고 있었다.\u003c/p\u003e\n\u003cp\u003e이미 Custom Networking으로 Pod의 IP 여유공간을 충분하다 못해 넘치게 설정한 내 입장에서는 도저히 이해할 수 없는 상황이었다.\u003c/p\u003e\n\u003cp\u003e그래서 문제를 찾던 도중 이런 상황이 eks node-group의 Node에서는 발생하지 않고 Karpenter에서 만든 Node에서만 발생한다는 사실을 알았다.\u003c/p\u003e\n\u003ch2\u003eNode가 할당 가능한 IP 개수\u003c/h2\u003e\n\u003cp\u003eKarpenter로 뜬 Node 하나의 스펙을 확인해봤다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/node-spec.png\" alt=\"node-spec\"\u003e\u003c/p\u003e\n\u003cp\u003e현재 Node는 t4g.medium type의 instance가 띄워진 상태였고 EC2 스펙에서 EC2의 할당 가능한 ENI개수를 확인해봤다.\u003c/p\u003e\n\u003ch3\u003eEC2 Network Spec\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/ec2-network-spec.png\" alt=\"ec2-network-spec\"\u003e\u003c/p\u003e\n\u003cp\u003et4g.large와 t4g.medium의 network interface를 확인해본 결과 각각 3개의 network interface가 존재하지만 network interface당 할당 가능한 IP가 12개, 6개로 되어 있었다.\u003c/p\u003e\n\u003cp\u003e계산상으로만 하면 t4g.large는 36개의 IP를, t4g.medium은 18개의 ip를 할당할 수 있다.\u003c/p\u003e\n\u003cp\u003e여기서 Node가 자체 IP를 가져야하기 때문에 Node IP 1개를 제외하면 각각 t4g.large는 35개, t4g.medium은 17개의 IP를 Pod에 할당할 수 있다.\u003c/p\u003e\n\u003ch3\u003eCustom Networking으로 Pod에 할당 가능한 IP 개수가 줄어들었다.\u003c/h3\u003e\n\u003cp\u003e그런데 EKS console 상에서 custom networking이 설정된 default node group의 EC2인 t4g.large에 35개의 Pod 할당이 아닌 24개의 Pod가 할당가능하다고 표시되어 있었다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/t4g.large-pod-cound.png\" alt=\"t4g.large-pod-cound\"\u003e\u003c/p\u003e\n\u003ch4\u003eCustom Networking의 할당 가능한 Pod 개수\u003c/h4\u003e\n\u003cp\u003eCustom Netoworking이 적용되지 않은 기존 EC2 Node의 Pod에 할당 가능한 IP 개수 계산은 아래와 같다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-scss\"\u003e(ENI count) * (IP addr per interface) - \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eENI개수에서 할당 가능한 IP 개수를 곱하고 Node가 가져가야할 IP 한개를 제외한 나머지 IP들을 모두 사용할 수 있다.\u003c/p\u003e\n\u003cp\u003e하지만 Custom Networking을 사용하는 순간 사용가능한 IP 개수가 완전히 바뀌게 된다.\u003c/p\u003e\n\u003cp\u003eENI 1개를 제외하고 나머지 ENI의 IP 할당 개수 만큼 사용할 수 있다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e(ENI count - 1) * (IP addr per interface)\n\ntg4.medium의 경우\n기존: 3 * 6 - 1(Node 자체 IP) = 17\ncustom network: (3-1) * \u003cspan class=\"hljs-attr\"\u003e6\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e이렇게 사용가능한 IP가 줄어드는 이유는 EC2 Node의 IP와 Pod의 IP가 완전히 서로 다른 대역을 사용하기 때문이다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/custom-networking.png\" alt=\"custom-networking\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e출처: \u003ca href=\"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html\"\u003eAWS Documentation\u003c/a\u003e\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e그림에서 보이듯이 Node는 10.0.0.0/24 대역을 사용하는 반면, Pod는 100.64.0.0/16 대역을 사용한다.\u003c/p\u003e\n\u003cp\u003eENI에서 할당하는 IP는 ENI가 속한 Subnet IP 대역의 IP로만 할당이 가능하다. 이 부분에서 Pod에 할당 가능한 IP 개수가 줄어들게 되는 것이다.\u003c/p\u003e\n\u003cp\u003eNode는 10.0.0.0/24 대역의 IP를 사용해야하기 때문에 ENI 하나를 사용해서 10.0.0.0/24 대역에 IP를 할당 받는다. 그리고 남은 ENI를 사용해서 Custom Networking을 사용할 IP 대역으로 ENI에 IP를 할당한다. 그래서 ENI 1개를 빼고 나머지 ENI에 대해서 곱한 개수만이 Pod의 IP로 할당 가능하다.\u003c/p\u003e\n\u003ch2\u003eKarpenter는 이 사실을 모른다!\u003c/h2\u003e\n\u003cp\u003eeks의 node group는 vpc-cni addon과 eks 자체 managed를 통해서 자동적으로 Node에 할당 가능한 IP를 알고 그 이상으로 Pod를 Scheduling하지 않는다.\u003c/p\u003e\n\u003cp\u003e하지만 Karpenter의 Node는 EKS에서 Managed되고 있는 Node가 아니라 Karpenter가 직접 Managed하고 있는 Node이다. 그래서 현재 EC2의 ENI 개수가 몇개인지, 할당 가능한 IP 개수가 변경되었는지도 모르고 기존의 IP할당 가능한 개수만큼의 Pod를 Node에 할당할 수 있다고 판단한다.\u003c/p\u003e\n\u003cp\u003e그래서 Node에서는 할당할 수 있는 IP가 없는데 Pod는 계속 Scheduling되려고 하는데 Karpenter는 아직 Node에 Pod가 할당할 수 있다고 판단하여 추가 Node를 생성하지 않는 것이다.\u003c/p\u003e\n\u003ch3\u003eHow to Fix?\u003c/h3\u003e\n\u003cp\u003e그래서 Custom Networking을 적용했을 때는 EC2의 ENI 1개를 사용할 수 없다는 걸 Karpenter에게 알려줘서 Node에 Scheduling될 수 있는 Pod의 개수를 조정해주어야한다.\u003c/p\u003e\n\u003ch3\u003eKarpenter 추가 설정\u003c/h3\u003e\n\u003ch4\u003eReservedENIs\u003c/h4\u003e\n\u003cp\u003eKarpenter 공식문서에서 이미 이 내용에 대해서 명시해주고 있다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/posts/contents/custom-networking-karpenter-eni-troubleshooting/karpenter-docs-note.png\" alt=\"karpenter-docs-note\"\u003e\u003c/p\u003e\n\u003cp\u003e내용은 간단하다. Karpenter Node에 ENI 1개를 예약된 ENI로 등록하여 사용하지 않게 설정하면 된다. 기존 Karpenter values에서 아래의 값만 추가하면 된다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e\u003cspan class=\"hljs-comment\"\u003e# Karpenter values.yaml\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e## 중략...\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003esettings:\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eclusterName:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e${EKS_CLUSTER_NAME}\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003einterruptionQueue:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eKarpenter-${EKS_CLUSTER_NAME}-SpotInterruptionQueue\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003ereservedENIs:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"1\"\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e# 여기 추가\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e# 설정하지 않으면 default가 0, custom networking으로 1개의 eni를 사용할 수 없으므로 1을 입력하여 ENI 1개가 예약된 상태여서 사용할 수 없다고 명시\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eFixed\u003c/h2\u003e\n\u003cp\u003e기존에 이미 생성된 Node들은 변경된 설정을 인식하지 못해서 이전 설정 그대로 남아있다. 그래서 반드시 Node의 Drain, Delete를 통해서 새 Node를 생성하고 기존 Karpenter Node를 제거하여 ReservedENIs를 인식한 새 Node가 Pod를 실행하도록 해야한다.\u003c/p\u003e\n\u003ch3\u003eReference\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://karpenter.sh/docs/reference/settings/\"\u003eKarpenter Settings\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"])</script><script>self.__next_f.push([1,"5:[\"$\",\"div\",null,{\"className\":\"max-w-4xl mx-auto p-4 sm:p-8\",\"children\":[[\"$\",\"div\",null,{\"className\":\"mb-8\",\"children\":[\"$\",\"$Le\",null,{\"href\":\"/\",\"className\":\"text-accent hover:underline flex items-center\",\"children\":[[\"$\",\"svg\",null,{\"className\":\"w-4 h-4 mr-1\",\"fill\":\"none\",\"stroke\":\"currentColor\",\"viewBox\":\"0 0 24 24\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[\"$\",\"path\",null,{\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"strokeWidth\":\"2\",\"d\":\"M10 19l-7-7m0 0l7-7m-7 7h18\"}]}],\"Back to home\"]}]}],[\"$\",\"h1\",null,{\"className\":\"text-4xl font-extrabold text-foreground mb-4 leading-tight\",\"children\":\"Custom network Kapenter ENI troubleshooting\"}],[\"$\",\"p\",null,{\"className\":\"text-lg text-muted-foreground mb-6\",\"children\":\"2025-07-10\"}],[\"$\",\"div\",null,{\"className\":\"mb-6 flex flex-wrap gap-2\",\"children\":[[\"$\",\"span\",\"infra\",{\"className\":\"bg-blue-600/10 text-blue-400 px-2 py-0.5 rounded text-xs font-medium border border-blue-600/20\",\"children\":\"infra\"}]]}],[\"$\",\"article\",null,{\"className\":\"prose lg:prose-xl prose-lg dark:prose-invert max-w-none\",\"children\":[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$f\"}}]}],[\"$\",\"div\",null,{\"className\":\"mt-16 pt-8 border-t border-card\",\"children\":[[\"$\",\"h2\",null,{\"className\":\"text-2xl font-bold text-foreground mb-6\",\"children\":\"Comments\"}],[\"$\",\"$L10\",null,{\"repo\":\"comstering/comstering.github.io\",\"repoId\":\"MDEwOlJlcG9zaXRvcnkzNjI0MjQ3NDk=\",\"category\":\"Announcements\",\"categoryId\":\"MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMyOTQ4OTYw\",\"mapping\":\"pathname\",\"strict\":\"0\",\"reactionsEnabled\":\"1\",\"emitMetadata\":\"0\",\"inputPosition\":\"top\",\"theme\":\"dark_high_contrast\",\"lang\":\"ko\",\"loading\":\"lazy\"}]]}]]}]\n"])</script><script>self.__next_f.push([1,"a:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n7:null\n"])</script><script>self.__next_f.push([1,"8:null\nc:[[\"$\",\"title\",\"0\",{\"children\":\"Custom network Kapenter ENI troubleshooting\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"Karpenter Node가 할당 가능한 IP 개수보다 더 많은 Pod를 Scheduling 하는 문제 해결\"}],[\"$\",\"meta\",\"2\",{\"name\":\"keywords\",\"content\":\"infra, aws, eks, custom networking, karpenter, troubleshooting\"}],[\"$\",\"meta\",\"3\",{\"property\":\"og:title\",\"content\":\"Custom network Kapenter ENI troubleshooting\"}],[\"$\",\"meta\",\"4\",{\"property\":\"og:description\",\"content\":\"Karpenter Node가 할당 가능한 IP 개수보다 더 많은 Pod를 Scheduling 하는 문제 해결\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:url\",\"content\":\"https://comstering.github.io/posts/custom-networking-karpenter-eni-troubleshooting\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:image\",\"content\":\"https://comstering.github.io/eks.png\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:type\",\"content\":\"article\"}],[\"$\",\"meta\",\"8\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"9\",{\"name\":\"twitter:title\",\"content\":\"Custom network Kapenter ENI troubleshooting\"}],[\"$\",\"meta\",\"10\",{\"name\":\"twitter:description\",\"content\":\"Karpenter Node가 할당 가능한 IP 개수보다 더 많은 Pod를 Scheduling 하는 문제 해결\"}],[\"$\",\"meta\",\"11\",{\"name\":\"twitter:image\",\"content\":\"https://comstering.github.io/eks.png\"}],[\"$\",\"link\",\"12\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"1024x1024\"}]]\n"])</script></body></html>